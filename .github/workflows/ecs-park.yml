name: ECS Park (Stop Containers)

on:
  schedule:
    # Run at 6:00 PM UTC, Monday through Friday (cron: 0 18 ? * 2-6 *)
    # Note: GitHub Actions uses standard cron format (minute hour day month day-of-week)
    # This translates to: At 18:00 UTC on Monday through Friday
    - cron: '0 18 * * 1-5'

  workflow_dispatch:
    # Allow manual triggering of the workflow

jobs:
  park-ecs-service:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Park ECS service (set desired count to 0)
        env:
          AWS_REGIONS: ${{ vars.AWS_REGIONS }}
        run: |
          if [ -z "$AWS_REGIONS" ]; then
            echo "AWS_REGIONS not set, defaulting to us-east-1"
            AWS_REGIONS="us-east-1"
          fi
          
          echo "Parking ECS services (stopping all containers)..."
          
          for region in $AWS_REGIONS; do
            echo "Parking ECS service in $region (setting desired count to 0)"
            aws ecs update-service --region $region --cluster xform-service-alb-dev --service xform-service-alb-dev --desired-count 0 | jq ".service.deployments[].id" &
          done
          
          wait
          
          echo "All ECS services have been parked successfully"
          
          for region in $AWS_REGIONS; do
            SERVICE_STATUS=$(aws ecs describe-services --region $region --cluster xform-service-alb-dev --services xform-service-alb-dev | jq -r '.services[0].desiredCount')
            echo "Region $region: Desired count is now $SERVICE_STATUS"
          done

