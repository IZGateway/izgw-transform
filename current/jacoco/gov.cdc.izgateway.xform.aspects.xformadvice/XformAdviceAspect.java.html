<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XformAdviceAspect.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">xform</a> &gt; <a href="index.source.html" class="el_package">gov.cdc.izgateway.xform.aspects.xformadvice</a> &gt; <span class="el_source">XformAdviceAspect.java</span></div><h1>XformAdviceAspect.java</h1><pre class="source lang-java linenums">package gov.cdc.izgateway.xform.aspects.xformadvice;

import ca.uhn.hl7v2.HL7Exception;
import ca.uhn.hl7v2.model.Message;
import gov.cdc.izgateway.xform.context.ServiceContext;
import gov.cdc.izgateway.xform.enums.DataFlowDirection;
import gov.cdc.izgateway.xform.logging.advice.*;
import gov.cdc.izgateway.xform.operations.Operation;
import gov.cdc.izgateway.xform.preconditions.Precondition;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;

import java.util.UUID;

@Aspect
<span class="nc" id="L17">public class XformAdviceAspect {</span>

    @Around(&quot;execution(* *(..)) &amp;&amp; @annotation(gov.cdc.izgateway.xform.annotations.CaptureXformAdvice)&quot;)
    public Object processXformAdviceAspect(ProceedingJoinPoint joinPoint) throws Throwable {
<span class="nc" id="L21">        boolean hasErrored = false;</span>

<span class="nc" id="L23">        addAdvice(joinPoint, MethodDisposition.PREEXECUTION, hasErrored);</span>

        try {
<span class="nc" id="L26">            return joinPoint.proceed();</span>
<span class="nc" id="L27">        } catch (Exception e) {</span>
<span class="nc" id="L28">            hasErrored = true;</span>
<span class="nc" id="L29">            throw e;</span>
        } finally {
<span class="nc" id="L31">            addAdvice(joinPoint, MethodDisposition.POSTEXECUTION, hasErrored);</span>
        }

    }

    private void addAdvice(ProceedingJoinPoint joinPoint, MethodDisposition methodDisposition, boolean hasErrored) throws HL7Exception {
<span class="nc bnc" id="L37" title="All 2 branches missed.">        for (Object arg : joinPoint.getArgs()) {</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">            if (arg instanceof ServiceContext context) {</span>
<span class="nc" id="L39">                XformAdviceCollector.getTransactionData().addAdvice(getXformAdvice(joinPoint, context, methodDisposition, hasErrored));</span>
<span class="nc" id="L40">                break;</span>
            }
        }
<span class="nc" id="L43">    }</span>

    private XformAdviceDTO getXformAdvice(ProceedingJoinPoint joinPoint, ServiceContext context, MethodDisposition methodDisposition, boolean hasErrored) throws HL7Exception {
        XformAdviceDTO xformAdvice;

<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (AdviceUtil.isPipelineAdvice(joinPoint.getTarget().getClass().getSimpleName())) {</span>
<span class="nc" id="L49">            xformAdvice = new PipelineAdviceDTO();</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        } else if (AdviceUtil.isSolutionAdvice(joinPoint.getTarget().getClass().getSimpleName())) {</span>
<span class="nc" id="L51">            xformAdvice = new SolutionAdviceDTO();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        } else if (joinPoint.getTarget() instanceof Operation) {</span>
<span class="nc" id="L53">            xformAdvice = new OperationAdviceDTO();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        } else if (joinPoint.getTarget() instanceof Precondition) {</span>
<span class="nc" id="L55">            xformAdvice = new PreconditionAdviceDTO();</span>
        } else {
<span class="nc" id="L57">            return null;</span>
        }

<span class="nc" id="L60">        populateAdvice(xformAdvice, joinPoint, context, methodDisposition, hasErrored);</span>

<span class="nc" id="L62">        return xformAdvice;</span>
    }

    private void populateAdvice(XformAdviceDTO xformAdvice, ProceedingJoinPoint joinPoint, ServiceContext context, MethodDisposition methodDisposition, boolean hasErrored) throws HL7Exception {
<span class="nc" id="L66">        String name = &quot;Unknown&quot;;</span>
<span class="nc" id="L67">        UUID id = null;</span>
<span class="nc" id="L68">        boolean hasTransformed = false;</span>

<span class="nc" id="L70">        Object targetObject = joinPoint.getTarget();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (targetObject instanceof Advisable advisable) {</span>
<span class="nc" id="L72">            name = advisable.getName();</span>
<span class="nc" id="L73">            id = advisable.getId();</span>
        }

<span class="nc bnc" id="L76" title="All 4 branches missed.">        if (methodDisposition == MethodDisposition.POSTEXECUTION &amp;&amp; xformAdvice instanceof PipelineAdviceDTO) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            hasTransformed = context.getCurrentDirection() == DataFlowDirection.REQUEST</span>
<span class="nc" id="L78">                    ? XformAdviceCollector.getTransactionData().getPipelineAdvice().isRequestTransformed()</span>
<span class="nc" id="L79">                    : XformAdviceCollector.getTransactionData().getPipelineAdvice().isResponseTransformed();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        } else if (targetObject instanceof Transformable transformable) {</span>
<span class="nc" id="L81">            hasTransformed = transformable.hasTransformed();</span>
        }

<span class="nc" id="L84">        xformAdvice.setClassName(joinPoint.getTarget().getClass().getSimpleName());</span>
<span class="nc" id="L85">        xformAdvice.setName(name);</span>
<span class="nc" id="L86">        xformAdvice.setId(id);</span>
<span class="nc" id="L87">        xformAdvice.setProcessError(hasErrored);</span>
<span class="nc" id="L88">        xformAdvice.setOrganizationId(context.getOrganizationId());</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if ( context.getCurrentDirection() == DataFlowDirection.REQUEST ) {</span>
<span class="nc" id="L91">            updateRequestMessage(context, methodDisposition, hasTransformed, xformAdvice);</span>
        } else {
<span class="nc" id="L93">            updateResponseMessage(context, methodDisposition, hasTransformed, xformAdvice);</span>
        }
<span class="nc" id="L95">    }</span>

    private void updateRequestMessage(ServiceContext context, MethodDisposition methodDisposition, boolean hasTransformed, XformAdviceDTO advice) throws HL7Exception {
<span class="nc bnc" id="L98" title="All 4 branches missed.">        if ( advice instanceof PipelineAdviceDTO &amp;&amp; methodDisposition == MethodDisposition.PREEXECUTION) {</span>
<span class="nc" id="L99">            advice.setRequest(context.getRequestMessage().encode());</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">        } else if ( methodDisposition == MethodDisposition.POSTEXECUTION &amp;&amp; hasTransformed) {</span>
<span class="nc" id="L101">            advice.setTransformedRequest(context.getRequestMessage().encode());</span>
        }
<span class="nc" id="L103">    }</span>

    private void updateResponseMessage(ServiceContext context, MethodDisposition methodDisposition, boolean hasTransformed, XformAdviceDTO advice) throws HL7Exception {
<span class="nc" id="L106">        Message responseMessage = context.getResponseMessage();</span>

<span class="nc bnc" id="L108" title="All 4 branches missed.">        if ( advice instanceof PipelineAdviceDTO &amp;&amp; methodDisposition == MethodDisposition.PREEXECUTION ) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            advice.setResponse(responseMessage == null ? null : responseMessage.encode());</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">        } else if ( methodDisposition == MethodDisposition.POSTEXECUTION &amp;&amp; hasTransformed) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            advice.setTransformedResponse(responseMessage == null ? null : responseMessage.encode());</span>
        }
<span class="nc" id="L113">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>